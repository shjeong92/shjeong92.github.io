<!DOCTYPE html><html lang="ko">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>[ #2 ] Kubernetes 설치 및 환경 구성하기  - Hyuk's devlog</title>

<meta name="description" content="minikube를 이용하면 정말 간단하게 로컬머신에 테스트환경을 구성할 수 있었습니다 또한 kubectl 커맨드에 친숙해지는데 잘 활용했었지요, 하지만 이는 싱글 노드 클러스트이고, 다른 노드를 추가할 수 없습니다. 그 말은 즉 진또배기 쿠버네티스를 체험할 수 없는것이며 모는 기능...">
<link rel="canonical" href="https://shjeong92.github.io/2021/05/27/Learning-Kubernetes-02.html"><link rel="alternate" type="application/rss+xml" title="Hyuk's devlog" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root">
<div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner">
<div class="page__header d-print-none">
<header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="24px" height="24px" viewbox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"></path>
</svg>
<a title="Your Site Description
" href="/">Hyuk's devlog</a>
</div>
<button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button>
</div>
<nav class="navigation">
        <ul>
<li class="navigation__item"><a href="/archive.html">아카이브</a></li>
<li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li>
</ul>
      </nav>
</div>
  </header>
</div>
<div class="page__content"><div class="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto">
<!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>[ #2 ] Kubernetes 설치 및 환경 구성하기 </h1></header></div>
<meta itemprop="headline" content="[ #2 ] Kubernetes 설치 및 환경 구성하기 ">
<div class="article__info clearfix">
<ul class="left-col menu">
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=Docker">Docker</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=Kubernetes">Kubernetes</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=CKA">CKA</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=%EB%8F%84%EC%BB%A4">도커</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88">컨테이너</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=container">container</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=etcd">etcd</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=Google">Google</a>
            </li>
<li>
              <a class="button button--secondary button--pill button--sm" href="/archive.html?tag=cloud">cloud</a>
            </li>
</ul>
<ul class="right-col menu"><li>
<i class="far fa-calendar-alt"></i> <span>2021년 05월 27일</span>
            </li></ul>
</div>
<meta itemprop="author" content="Sanghyuk Jeong">
<meta itemprop="datePublished" content="2021-05-27T00:00:00+09:00">
    <meta itemprop="keywords" content="Docker,Kubernetes,CKA,도커,컨테이너,container,etcd,Google,cloud">
<div class="js-article-content">
<div class="layout--article">
<!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody">
<hr>

<p>minikube를 이용하면 정말 간단하게 로컬머신에 테스트환경을 구성할 수 있었습니다 또한 <code>kubectl</code> 커맨드에 친숙해지는데 잘 활용했었지요,
 하지만 이는 싱글 노드 클러스트이고, 다른 노드를 추가할 수 없습니다. 그 말은 즉 진또배기 쿠버네티스를 체험할 수 없는것이며 모는 기능을 제대로 체험할 수 없다는 것이지요.</p>

<p><br>
따라서 kubeadm을 이용하여 마스터노드와 워커노드들을 구성해보기로 했습니다.
로컬 환경에서 vagrant와 virtualbox를 통해 실험환경을 구축하고싶었지만 m1 맥에 그런것은 없습니다 ㅠㅠ
어쩌다보니 구글 클라우드를 처음시작하면 무료크레딧으로 300$를 제공하는것을 발견하였고 구글클라우드를 이용하여 쿠버네티스 환경을 구축해보기로 결정했습니다.</p>

<p><br>
이번 포스트에서는 쿠버네티스 설치부터 기본적인 환경까지 구성할것입니다.</p>

<hr>

<p>쿠버네티스는 기본적으로 <code>마스터 노드</code> 와 <code>워커 노드</code>로 구성됩니다.</p>

<p><code>마스터 노드</code>는 <code>워커 노드</code>에 Pod를 할당하고 Pod 안에 컨테이너를 띄우게 하는 역할을 합니다.
또한 쿠버네티스의 상태를 관리하고 여러 Pod 들의 스케줄링도 하는 등 쿠버네티스에서 중추적인 역할을 합니다.
<code>워커 노드</code>는 <code>마스터 노드</code>와 통신하면서 Pod를 할당 받고 그 안에 컨테이너를 띄워 유지 및 관리하는 역할을 합니다. 
또한 네트워크나 볼륨에 대한 기능도 컨트롤도 합니다.</p>

<p>마스터 노드1개와 와 워커 노드 2개를 생성할 것이며, 
운영체제는 Ubuntu 18.04 LTS 를 사용하여 구성하도록 하겠습니다.
<br>
그리고 마스터 및 모든 워커노드의 스펙은 아래와 같습니다.</p>

<ul>
  <li>CPU : 2 core</li>
  <li>RAM : 2 GB</li>
  <li>Storage : 30 GB</li>
</ul>

<hr>

<h2 id="kubeadm을-활용한-환경구축">kubeadm을 활용한 환경구축</h2>

<p><code>kubeadm</code>이란, kubernetes에서 제공하는 기본적인 도구이며, 
kubernetes 클러스터를 빨리 구축하기 위한 다양한 기능을 제공합니다.</p>

<p><code>kubeadm</code>은 아래와같이 다양한 커맨드명령어를 사용하여 클러스터를 구축할 수 있습니다.</p>

<ul>
  <li>
<strong>kubeadm init</strong>
    <ul>
      <li>Kubernetes 컨트롤 플레인 노드를 초기화합니다.</li>
      <li>즉, 마스터 노드를 초기화합니다.</li>
    </ul>
  </li>
  <li>
<strong>kubeadm join</strong>
    <ul>
      <li>Kubernetes 워커 노드를 초기화하고 클러스터에 연결합니다.</li>
    </ul>
  </li>
  <li>
<strong>kubeadm upgrade</strong>
    <ul>
      <li>Kubernetes 클러스터를 업그레이드 합니다.</li>
    </ul>
  </li>
  <li>
<strong>kubeadm token</strong>
    <ul>
      <li>부트 스트랩 토큰을 사용한 인증에 설명된대로 부트 스트랩 토큰은 클러스터에 참여하는 노드와 제어 평면 노드 사이에 양방향 신뢰를 설정하는 데 사용됩니다.</li>
    </ul>
  </li>
  <li>
<strong>kubeadm reset</strong>
    <ul>
      <li>kubeadm init 혹은 kubeadm join의 변경사항을 최대한 복구합니다.</li>
    </ul>
  </li>
  <li>
<strong>kubeadm version</strong>
    <ul>
      <li>kubeadm 버젼을 보여줍니다.</li>
    </ul>
  </li>
  <li>
<strong>kubeadm alpha</strong>
    <ul>
      <li>정식으로 배포된 기능은 아니지만 kubernetes측에서 사용자 피드백을 얻기 위해 인증서 갱신, 인증서 만료 확인, 사용자 생성, kubelet 설정 등 다양한 기능을 제공한다고 합니다.</li>
    </ul>
  </li>
</ul>

<hr>

<h2 id="시작하기전에-확인할-것">시작하기전에 확인할 것</h2>

<ul>
  <li>2GB 또는 그 이상의 메모리(각노드별)</li>
  <li>2CPUs 또는 그이상의 시피유</li>
  <li>클러스터의 모든 시스템 간 완벽한 네트워크 연결되었는지 확인</li>
  <li>모든 노드에 대한 고유한 호스트 이름, 고유한 MAC 주소, 고유한 product_uuid</li>
  <li>각노드의 컨트롤러인 kubelet이 제대로 동작하기위해선 swap이 disabled 되어야 합니다.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#swap 비활성화하기</span>
swapoff <span class="nt">-a</span>
</code></pre></div></div>

<hr>

<h2 id="모든-노드의-mac-address-및-product_uuid-확인">모든 노드의 Mac address 및 product_uuid 확인</h2>

<p>로컬 머신의경우 하드웨어 기기들은 각각의 유니크한 주소를 가지는 반면에 가상 머신은 같은 id를 가질 수도 있습니다.
만약에 같은 Mac address 및 product_uuid를 가지고 있으면 설치에 실패 할 수 있기에 확인하여야 합니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#MAC address 확인하기</span>
ifconfig <span class="nt">-a</span>

<span class="c">#product_uuid 확인하기</span>
<span class="nb">sudo cat</span> /sys/class/dmi/id/product_uuid
</code></pre></div></div>
<p>위 쉘 커맨드를 각각의노드에 적용하여 중복되는 맥주소나 제품아이디가 있는지 확인합니다.</p>

<hr>

<h2 id="iptables-설정하기">iptables 설정하기</h2>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#br_netfilter모듈 로드되었는지 확인하기</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep </span>br_netfilter
<span class="c"># 아무정보도 뜨지않는다.</span>
<span class="nv">$ </span>

<span class="c">#명시적으로 br_netfilter 로드하기</span>
<span class="nv">$ </span><span class="nb">sudo </span>modprobe br_netfilter
<span class="c">#다시 확인하면 br_netfilter이 로드된걸 볼수 있어요.</span>
<span class="nv">$ </span>lsmod | <span class="nb">grep </span>br_netfilter
br_netfilter           28672  0
bridge                176128  1 br_netfilter

</code></pre></div></div>

<p>리눅스 노드의 iptables가 브리지된 트래픽을 올바르게 보기 위한 요구 사항으로, sysctl 구성에서 net.bridge.bridge-nf-call-iptables 가 1로 설정되어 있는지 확인해야 합니다. 
다음3개의 스크립트를 실행해주시면,</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">sudo </span>sysctl <span class="nt">--system</span>
</code></pre></div></div>

<p>아래와같이 뜰거에요.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* Applying /etc/sysctl.d/10-console-messages.conf ...
kernel.printk = 4 4 1 7
* Applying /etc/sysctl.d/10-ipv6-privacy.conf ...
net.ipv6.conf.all.use_tempaddr = 2
net.ipv6.conf.default.use_tempaddr = 2
* Applying /etc/sysctl.d/10-kernel-hardening.conf ...
kernel.kptr_restrict = 1
* Applying /etc/sysctl.d/10-link-restrictions.conf ...
fs.protected_hardlinks = 1
fs.protected_symlinks = 1
* Applying /etc/sysctl.d/10-lxd-inotify.conf ...
fs.inotify.max_user_instances = 1024
* Applying /etc/sysctl.d/10-magic-sysrq.conf ...
kernel.sysrq = 176
* Applying /etc/sysctl.d/10-network-security.conf ...
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.tcp_syncookies = 1
* Applying /etc/sysctl.d/10-ptrace.conf ...
kernel.yama.ptrace_scope = 1
* Applying /etc/sysctl.d/10-zeropage.conf ...
vm.mmap_min_addr = 65536
* Applying /usr/lib/sysctl.d/50-default.conf ...
net.ipv4.conf.all.promote_secondaries = 1
net.core.default_qdisc = fq_codel
* Applying /etc/sysctl.d/60-gce-network-security.conf ...
net.ipv4.tcp_syncookies = 1
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 1
net.ipv4.conf.default.secure_redirects = 1
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
kernel.randomize_va_space = 2
kernel.panic = 10
* Applying /etc/sysctl.d/99-cloudimg-ipv6.conf ...
net.ipv6.conf.all.use_tempaddr = 0
net.ipv6.conf.default.use_tempaddr = 0
* Applying /etc/sysctl.d/99-sysctl.conf ...
* Applying /etc/sysctl.d/k8s.conf ...
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
* Applying /etc/sysctl.conf ...

</code></pre></div></div>

<hr>

<h2 id="필수-포트-확인하기">필수 포트 확인하기</h2>
<p><strong>마스터 노드에서 필요한 필수 노트</strong></p>
<ul>
  <li>6443 포트 : Kubernetes API Server / Used By All</li>
  <li>2379~2380 포트 : etcd server client API / Used By kube-apiserver, etcd</li>
  <li>10250 포트 : Kubelet API / Used By Self, Control plane</li>
  <li>10251 포트 : kube-scheduler / Used By Self</li>
  <li>10252 포트 : kube-controller-manager / Used By Self</li>
</ul>

<p><strong>워커 노드에서 필요한 필수 포트</strong></p>
<ul>
  <li>10250 포트 : Kubelet API / Used By Self, Control plane</li>
  <li>30000~32767 포트 : NodePort Services / Used By All</li>
</ul>

<hr>

<h2 id="컨테이너-런타임-설치하기">컨테이너 런타임 설치하기</h2>
<p>저는 docker를 설치할 것입니다..</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 구버전의 도커 설치되어있다면 삭제하기.</span>
<span class="nv">$ </span> <span class="nb">sudo </span>apt-get remove docker docker-engine docker.io containerd runc
</code></pre></div></div>

<p>도커 공홈에가면 도커 설치하는 방법이 여러가지있는데 저는 그중에서 가장 간단한 방법으로 설치하겠습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#도커를 설치해주는 스크립트 get-docker.sh 로저장하기</span>
<span class="nv">$ </span>curl <span class="nt">-fsSL</span> https://get.docker.com <span class="nt">-o</span> get-docker.sh
<span class="c">#스크립트 실행하기</span>
<span class="nv">$ </span><span class="nb">sudo </span>sh get-docker.sh
</code></pre></div></div>

<p>아래와같이 뜨면 성공입니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Executing docker install script, commit: 7cae5f8b0decc17d6571f9f52eb840fbc13b2737</span>
+ sh <span class="nt">-c</span> apt-get update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null
+ sh <span class="nt">-c</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">-qq</span> apt-transport-https ca-certificates curl <span class="o">&gt;</span>/dev/null
+ sh <span class="nt">-c</span> curl <span class="nt">-fsSL</span> <span class="s2">"https://download.docker.com/linux/ubuntu/gpg"</span> | apt-key add <span class="nt">-qq</span> - <span class="o">&gt;</span>/dev/null
Warning: apt-key output should not be parsed <span class="o">(</span>stdout is not a terminal<span class="o">)</span>
+ sh <span class="nt">-c</span> <span class="nb">echo</span> <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"</span> <span class="o">&gt;</span> /etc/apt/sources.list.d/docker.list
+ sh <span class="nt">-c</span> apt-get update <span class="nt">-qq</span> <span class="o">&gt;</span>/dev/null
+ <span class="o">[</span> <span class="nt">-n</span>  <span class="o">]</span>
+ sh <span class="nt">-c</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">-qq</span> <span class="nt">--no-install-recommends</span> docker-ce <span class="o">&gt;</span>/dev/null
+ <span class="o">[</span> <span class="nt">-n</span> 1 <span class="o">]</span>
+ sh <span class="nt">-c</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">-qq</span> docker-ce-rootless-extras <span class="o">&gt;</span>/dev/null
+ sh <span class="nt">-c</span> docker version
Client: Docker Engine - Community
 Version:           20.10.6
 API version:       1.41
 Go version:        go1.13.15
 Git commit:        370c289
 Built:             Fri Apr  9 22:46:01 2021
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      <span class="nb">true

</span>Server: Docker Engine - Community
 Engine:
  Version:          20.10.6
  API version:      1.41 <span class="o">(</span>minimum version 1.12<span class="o">)</span>
  Go version:       go1.13.15
  Git commit:       8728dd2
  Built:            Fri Apr  9 22:44:13 2021
  OS/Arch:          linux/amd64
  Experimental:     <span class="nb">false
 </span>containerd:
  Version:          1.4.4
  GitCommit:        05f951a3781f4f2c1911b05e61c160e9c30eaa8e
 runc:
  Version:          1.0.0-rc93
  GitCommit:        12644e614e25b05da6fd08a38ffa0cfe1903fdec
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0

<span class="o">================================================================================</span>

To run Docker as a non-privileged user, consider setting up the
Docker daemon <span class="k">in </span>rootless mode <span class="k">for </span>your user:

    dockerd-rootless-setuptool.sh <span class="nb">install

</span>Visit https://docs.docker.com/go/rootless/ to learn about rootless mode.


To run the Docker daemon as a fully privileged service, but granting non-root
<span class="nb">users </span>access, refer to https://docs.docker.com/go/daemon-access/

WARNING: Access to the remote API on a privileged Docker daemon is equivalent
         to root access on the host. Refer to the <span class="s1">'Docker daemon attack surface'</span>
         documentation <span class="k">for </span>details: https://docs.docker.com/go/attack-surface/

<span class="o">================================================================================</span>
</code></pre></div></div>

<p>혹시 모르니 도커 커맨드를 써서 설치가 잘되었는지 확인해봅니다</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
</code></pre></div></div>

<p>Docker 설치가 완료 되었으면, Docker 데몬이 사용하는 드라이버를 cgroupfs 대신 systemd를 사용하도록 설정합니다
왜냐하면 kubernetes에서 권장하는 Docker 데몬의 드라이버는 systemd 이기 때문이고, systemd를 사용하면 kubernetes가 클러스터 노드에서 사용 가능한 자원을 쉽게 알 수 있도록 해주기 때문입니다.
또한, 시스템에 두개의 cgroup관리자가 있으면 리소스가 부족할 때 불안정해지는 사례가 있다고 하니 무조건적으로 설정해줍시다.
아래 명령어를 통해 Docker 데몬의 드라이버를 교체합니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo mkdir</span> /etc/docker

<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
</span><span class="no">EOF

</span><span class="c">#도커 재시작과 부팅시 실행되게 설정</span>
<span class="nv">$ </span><span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker
<span class="nv">$ </span><span class="nb">sudo </span>systemctl daemon-reload
<span class="nv">$ </span><span class="nb">sudo </span>systemctl restart docker
</code></pre></div></div>

<hr>

<h2 id="kubeadm-kubelet-및-kubectl-설치하기">kubeadm, kubelet 및 kubectl 설치하기</h2>

<p><strong>kubeadm은 kubelet 또는 kubectl 을 설치하거나 관리하지 않으므로, kubeadm이 설치하려는 쿠버네티스 컨트롤 플레인의 버전과 일치하는지 확인해야 합니다</strong>
따라서 kubeadm 및 쿠버네티스를 업그레이드 할 때에는 버전에 신경쓰셔야 합니다.</p>

<p>아래에서는 kubeadm, kubelet, 및 kubectl 설치후에 업데이트를 홀드 시킴으로써 실수로 <code>sudo apt-get update</code>
실행한 커맨드가 해당 패키지에 영향이 가지 않도록 할것입니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 패키지 색인을 최신으로 업데이트하고, kubeadm, kubelet, 및 kubectl 를 설치하는데 필요한 패키지 설치하기.</span>
<span class="nv">$ </span><span class="nb">sudo </span>apt-get update
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https ca-certificates curl

<span class="c"># 구글 클라우드의 공개 사이닝 키를 다운로드 하기.</span>
<span class="nv">$ </span><span class="nb">sudo </span>curl <span class="nt">-fsSLo</span> /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg

<span class="c"># 쿠버네티스 apt 리포지터리를 추가하기.</span>
<span class="c"># *apt리포는 apt 도구로 읽을 수있는 deb 패키지 및 메타 데이터 파일이 포함 된 네트워크 서버 또는 로컬 디렉토리입니다*</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/kubernetes.list

<span class="c"># apt 패키지 색인을 업데이트 후 kubeadm, kubelet 및 kubectl다운로드 한다음, 버전 고정시키기.</span>
<span class="nv">$ </span><span class="nb">sudo </span>apt-get update
<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm kubectl
<span class="nv">$ </span><span class="nb">sudo </span>apt-mark hold kubelet kubeadm kubectl
</code></pre></div></div>

<h1 id="star처음부터-이-줄-윗부분까지는-마스터노드와-워커노드-모두에-적용되어야-할-내용입니다star">
<img class="emoji" title=":star:" alt=":star:" src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png" height="20" width="20">처음부터 이 줄 윗부분까지는 마스터노드와 워커노드 모두에 적용되어야 할 내용입니다<img class="emoji" title=":star:" alt=":star:" src="https://github.githubassets.com/images/icons/emoji/unicode/2b50.png" height="20" width="20">
</h1>

<hr>

<h2 id="마스터-노드-세팅">마스터 노드 세팅</h2>

<p>마스터 노드를 실행시키려면 <code>kubeadm init</code> 커맨드를 사용해야합니다.
해당명령어에는 여러가지 옵션이 들어가는데, 여기서 필요한 옵션값은 다음과 같습니다.</p>

<ul>
  <li>–pod-network-cidr : Pod 네트워크를 설정할 때 사용</li>
  <li>–apiserver-advertise-address : 특정 마스터 노드의 API Server 주소를 설정할 때 사용</li>
</ul>

<h2 id="pod-네트워크-설정">Pod 네트워크 설정</h2>
<p>우선 세팅할 클러스터에서 Pod가 서로 통신할 수 있도록 Pod 네트워크 애드온을 설치 해야 합니다.
kubeadm을 통해 만들어진 클러스터는 CNI(Container Network Interface) 기반의 애드온이 필요합니다.</p>

<p>기본적으로 k8s에서 제공해주는 kubenet이라는 네트워크 플러그인이 있지만, 
매우 기본적이고 간단한 기능만 제공하는 네트워크 플러그인이기 때문에 이 자체로는 크로스 노드 네트워킹이나 네트워크 정책과 같은 기능들은 구현되어 있지 않습니다.
따라서 kubeadm은 kubernetes가 기본적으로 지원해주는 네트워크 플러그인인 kubenet을 지원하지 않고, CNI 기반 네트워크만 지원합니다.
여기서는 Flannel이라는 Pod 네트워크 애드온을 설치하여 사용할 것입니다.
<br>
Flannel을 사용하려면 kubeadm init 명령어에 –pod-network-cidr=10.244.0.0/16 이라는 인자를 추가해서 실행해야 하며,
 10.244.0.0/16 이라는 네트워크는 Flannel에서 기본적으로 권장하는 네트워크 대역입니다.
<br>
Pod 네트워크가 호스트 네트워크와 겹치면 문제가 발생할 수 있기 때문에 일부로 호스트 네트워크로 잘 사용하지 않을 것 같은 네트워크 대역을 권장하는 것입니다.</p>

<h2 id="api-server-주소-설정">API Server 주소 설정</h2>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#마스터노드입니다.</span>
<span class="nv">$ </span>ifconfig 

cni0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1410
        inet 10.244.0.1  netmask 255.255.255.0  broadcast 10.244.0.255
        inet6 fe80::44f7:e3ff:fe0e:7d15  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 46:f7:e3:0e:7d:15  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 48997  bytes 4021971 <span class="o">(</span>4.0 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 54114  bytes 4910238 <span class="o">(</span>4.9 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

docker0: <span class="nv">flags</span><span class="o">=</span>4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:29:4d:09:4f  txqueuelen 0  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens4: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1460
        inet 10.178.0.2  netmask 255.255.255.255  broadcast 0.0.0.0
        inet6 fe80::4001:aff:feb2:2  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 42:01:0a:b2:00:02  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 456862  bytes 219264003 <span class="o">(</span>219.2 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 291537  bytes 122783503 <span class="o">(</span>122.7 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<p>위 <code>ifconfig</code> 커맨드의 출력에서 해당 마스터 노드의 IPv4 주소는 ens4 이더넷의 10.178.0.2 인것을 확인할 수 있고, 
<br>
<code>--apiserver-advertise-address</code> 옵션을 통해 해당 주소를 kubeadm 에게 전달할 수 있습니다.</p>

<h2 id="rocket마스터-노드-생성-및-실행">
<img class="emoji" title=":rocket:" alt=":rocket:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f680.png" height="20" width="20">마스터 노드 생성 및 실행</h2>

<p>최종적으로 실행할 <code> kubeadm init </code>는 아래와 같습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>kubeadm init <span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16 <span class="nt">--apiserver-advertise-address</span><span class="o">=</span>10.178.0.2
</code></pre></div></div>

<p>해당 명령어를 실행했을때 뜨는 결과 창인데요 여기서 짚고가야할 두가지가 있습니다</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>kubeadm init <span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16 <span class="nt">--apiserver-advertise-address</span><span class="o">=</span>10.178.0.2
<span class="o">[</span>init] Using Kubernetes version: v1.21.1
<span class="o">[</span>preflight] Running pre-flight checks
<span class="o">[</span>preflight] Pulling images required <span class="k">for </span>setting up a Kubernetes cluster
<span class="o">[</span>preflight] This might take a minute or two, depending on the speed of your internet connection
<span class="o">[</span>preflight] You can also perform this action <span class="k">in </span>beforehand using <span class="s1">'kubeadm config images pull'</span>
<span class="o">[</span>certs] Using certificateDir folder <span class="s2">"/etc/kubernetes/pki"</span>
<span class="o">[</span>certs] Generating <span class="s2">"ca"</span> certificate and key
<span class="o">[</span>certs] Generating <span class="s2">"apiserver"</span> certificate and key
<span class="o">[</span>certs] apiserver serving cert is signed <span class="k">for </span>DNS names <span class="o">[</span>kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master] and IPs <span class="o">[</span>10.96.0.1 10.178.0.2]
<span class="o">[</span>certs] Generating <span class="s2">"apiserver-kubelet-client"</span> certificate and key
<span class="o">[</span>certs] Generating <span class="s2">"front-proxy-ca"</span> certificate and key
<span class="o">[</span>certs] Generating <span class="s2">"front-proxy-client"</span> certificate and key
<span class="o">[</span>certs] Generating <span class="s2">"etcd/ca"</span> certificate and key
<span class="o">[</span>certs] Generating <span class="s2">"etcd/server"</span> certificate and key
<span class="o">[</span>certs] etcd/server serving cert is signed <span class="k">for </span>DNS names <span class="o">[</span>localhost master] and IPs <span class="o">[</span>10.178.0.2 127.0.0.1 ::1]
<span class="o">[</span>certs] Generating <span class="s2">"etcd/peer"</span> certificate and key
<span class="o">[</span>certs] etcd/peer serving cert is signed <span class="k">for </span>DNS names <span class="o">[</span>localhost master] and IPs <span class="o">[</span>10.178.0.2 127.0.0.1 ::1]
<span class="o">[</span>certs] Generating <span class="s2">"etcd/healthcheck-client"</span> certificate and key
<span class="o">[</span>certs] Generating <span class="s2">"apiserver-etcd-client"</span> certificate and key
<span class="o">[</span>certs] Generating <span class="s2">"sa"</span> key and public key
<span class="o">[</span>kubeconfig] Using kubeconfig folder <span class="s2">"/etc/kubernetes"</span>
<span class="o">[</span>kubeconfig] Writing <span class="s2">"admin.conf"</span> kubeconfig file
<span class="o">[</span>kubeconfig] Writing <span class="s2">"kubelet.conf"</span> kubeconfig file
<span class="o">[</span>kubeconfig] Writing <span class="s2">"controller-manager.conf"</span> kubeconfig file
<span class="o">[</span>kubeconfig] Writing <span class="s2">"scheduler.conf"</span> kubeconfig file
<span class="o">[</span>kubelet-start] Writing kubelet environment file with flags to file <span class="s2">"/var/lib/kubelet/kubeadm-flags.env"</span>
<span class="o">[</span>kubelet-start] Writing kubelet configuration to file <span class="s2">"/var/lib/kubelet/config.yaml"</span>
<span class="o">[</span>kubelet-start] Starting the kubelet
<span class="o">[</span>control-plane] Using manifest folder <span class="s2">"/etc/kubernetes/manifests"</span>
<span class="o">[</span>control-plane] Creating static Pod manifest <span class="k">for</span> <span class="s2">"kube-apiserver"</span>
<span class="o">[</span>control-plane] Creating static Pod manifest <span class="k">for</span> <span class="s2">"kube-controller-manager"</span>
<span class="o">[</span>control-plane] Creating static Pod manifest <span class="k">for</span> <span class="s2">"kube-scheduler"</span>
<span class="o">[</span>etcd] Creating static Pod manifest <span class="k">for </span><span class="nb">local </span>etcd <span class="k">in</span> <span class="s2">"/etc/kubernetes/manifests"</span>
<span class="o">[</span>wait-control-plane] Waiting <span class="k">for </span>the kubelet to boot up the control plane as static Pods from directory <span class="s2">"/etc/kubernetes/manifests"</span><span class="nb">.</span> This can take up to 4m0s
<span class="o">[</span>apiclient] All control plane components are healthy after 12.003615 seconds
<span class="o">[</span>upload-config] Storing the configuration used <span class="k">in </span>ConfigMap <span class="s2">"kubeadm-config"</span> <span class="k">in </span>the <span class="s2">"kube-system"</span> Namespace
<span class="o">[</span>kubelet] Creating a ConfigMap <span class="s2">"kubelet-config-1.21"</span> <span class="k">in </span>namespace kube-system with the configuration <span class="k">for </span>the kubelets <span class="k">in </span>the cluster
<span class="o">[</span>upload-certs] Skipping phase. Please see <span class="nt">--upload-certs</span>
<span class="o">[</span>mark-control-plane] Marking the node master as control-plane by adding the labels: <span class="o">[</span>node-role.kubernetes.io/master<span class="o">(</span>deprecated<span class="o">)</span> node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
<span class="o">[</span>mark-control-plane] Marking the node master as control-plane by adding the taints <span class="o">[</span>node-role.kubernetes.io/master:NoSchedule]
<span class="o">[</span>bootstrap-token] Using token: ol9g7l.d1f7klw0uh9kmsm5
<span class="o">[</span>bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="k">in </span>order <span class="k">for </span>nodes to get long term certificate credentials
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<span class="o">[</span>bootstrap-token] configured RBAC rules to allow certificate rotation <span class="k">for </span>all node client certificates <span class="k">in </span>the cluster
<span class="o">[</span>bootstrap-token] Creating the <span class="s2">"cluster-info"</span> ConfigMap <span class="k">in </span>the <span class="s2">"kube-public"</span> namespace
<span class="o">[</span>kubelet-finalize] Updating <span class="s2">"/etc/kubernetes/kubelet.conf"</span> to point to a rotatable kubelet client certificate and key
<span class="o">[</span>addons] Applied essential addon: CoreDNS
<span class="o">[</span>addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
  <span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
  <span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config

Alternatively, <span class="k">if </span>you are the root user, you can run:

  <span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="s2">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="nb">join </span>any number of worker nodes by running the following on each as root:

kubeadm <span class="nb">join </span>10.178.0.2:6443 <span class="nt">--token</span> ol9g7l.d1f7klw0uh9kmsm5 <span class="se">\</span>
	<span class="nt">--discovery-token-ca-cert-hash</span> sha256:723e45876b6726f23ff39566d6ae9046423edae440fd76bd328b40ab9b0a8b7d 
</code></pre></div></div>

<hr>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 첫째로는 마스터노드에서 실행해야할 커맨드에요</span>
<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nv">$ </span><span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nv">$ </span><span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></div></div>
<p>해당 명령어는 Root 계정이 아닌 다른 사용자 계정에서 kubectl 커맨드 명령어를 사용하여 클러스터를 제어하기 위해 사용하는 명령어입니다.
기본적으로 kubernetes에서는 /etc/kubernetes/admin.conf 파일을 가지고 kubernetes 관리자 Role의 인증 및 인가 처리를 하며, 
위 명령어는 사용자 계정의 $HOME/.kube/config 디렉터리에 admin.conf 파일을 복사함으로써 사용자 계정이 kubectl을 사용하면서 관리자 Role의 인증 및 인가 처리를 받을 수 있도록 하는 것입니다.
여기서 말한 사용자 계정이란, 마스터 노드의 Shell에 접속한 계정입니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#두번째로는 각각의 워커노드에 실행시켜줄 커맨드에요 메모장에 복사붙여놓기 해놓으시길 추천드립니다!</span>

<span class="nv">$ </span>kubeadm <span class="nb">join </span>10.178.0.2:6443 <span class="nt">--token</span> ol9g7l.d1f7klw0uh9kmsm5 <span class="se">\</span>
	<span class="nt">--discovery-token-ca-cert-hash</span> sha256:723e45876b6726f23ff39566d6ae9046423edae440fd76bd328b40ab9b0a8b7d 
</code></pre></div></div>
<p>잃어버리면 토큰 다시받아야하고 귀찮아집니다
물론 24시간지나면 토큰 다시 받아야하긴 하지만요 ㅎㅎ</p>

<h2 id="flanner-사용을-위해-pod-네트워크-배포하기">Flanner 사용을 위해 Pod 네트워크 배포하기</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre></div></div>
<p>이 명령어를 실행하면 아래와 같은 메세지를 확인할 수 있습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds created
</code></pre></div></div>

<p>이제 마스터 노드가 잘 세팅되었는지 아래 명령어를 통해 확인해볼 수 있습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>노드 확인하기
<span class="nv">$ </span>kubectl get nodes
NAME         STATUS   ROLES                  AGE   VERSION
master       Ready    control-plane,master   49m   v1.21.1

마스터 노드 내의 모든 pod 확인하기
<span class="nv">$ </span>kubectl get pods <span class="nt">--all-namespaces</span>
NAMESPACE     NAME                             READY   STATUS    RESTARTS   AGE
kube-system   coredns-558bd4d5db-8mclv         1/1     Running   0          49m
kube-system   coredns-558bd4d5db-qbs2t         1/1     Running   0          49m
kube-system   etcd-master                      1/1     Running   0          50m
kube-system   kube-apiserver-master            1/1     Running   0          50m
kube-system   kube-controller-manager-master   1/1     Running   0          50m
kube-system   kube-flannel-ds-dmbnj            1/1     Running   0          45m
kube-system   kube-flannel-ds-gmhfd            1/1     Running   0          44m
kube-system   kube-flannel-ds-h27rp            1/1     Running   0          46m
kube-system   kube-flannel-ds-smnhd            1/1     Running   0          45m
kube-system   kube-proxy-2hxsg                 1/1     Running   0          49m
kube-system   kube-proxy-dhgfh                 1/1     Running   0          44m
kube-system   kube-proxy-q9kwk                 1/1     Running   0          45m
kube-system   kube-proxy-x7m4d                 1/1     Running   0          45m
kube-system   kube-scheduler-master            1/1     Running   0          50m

</code></pre></div></div>

<h2 id="워커-노드-세팅">워커 노드 세팅</h2>

<p>마스터 노드 생성후 출력된 메세지 맨아래에서 저장 해놓으라고 했던부분을 쓸 시간이 왔습니다.</p>

<p><strong>연결하고싶은 모든 워커노드에 아래 커맨드를 입력해주세요</strong></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span>kubeadm <span class="nb">join </span>10.178.0.2:6443 <span class="nt">--token</span> ol9g7l.d1f7klw0uh9kmsm5 <span class="se">\</span>
	<span class="nt">--discovery-token-ca-cert-hash</span> sha256:723e45876b6726f23ff39566d6ae9046423edae440fd76bd328b40ab9b0a8b7d 
</code></pre></div></div>

<h2 id="마스터노드에서-확인하기">마스터노드에서 확인하기</h2>

<p>원래 두개 등록되어있었는데 포스트 작성하면서 하나 더만들어졌네요
두번째 만들때는 그래도 수월하게 진행한것 같습니다.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get nodes
NAME         STATUS   ROLES                  AGE   VERSION
instance-1   Ready    &lt;none&gt;                 44m   v1.21.1
master       Ready    control-plane,master   49m   v1.21.1
worker-1     Ready    &lt;none&gt;                 44m   v1.21.1
worker-2     Ready    &lt;none&gt;                 44m   v1.21.1
</code></pre></div></div>

<p>긴 글 보시느라 고생많으셨습니다.</p>
</div>
<section class="article__sharing d-print-none"></section><div class="d-print-none">
<footer class="article__footer"><meta itemprop="dateModified" content="2021-05-27T00:00:00+09:00">
<!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe">
<div class="subscribe">
<i class="fas fa-rss"></i> <a type="application/rss+xml" href="/feed.xml">구독하기</a>
</div>
</div></footer>
<div class="article__section-navigator clearfix">
<div class="previous">
<span>이전</span><a href="/2021/05/26/Learning-Kubernetes-01.html">[ #1 ] Kubernetes의 구조</a>
</div>
<div class="next">
<span>다음</span><a href="/2021/05/28/Learning-Kubernetes-03.html">[ #3 ] Replicasets &amp; Deployment </a>
</div>
</div>
</div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div>
<section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div>
<div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main">
<div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sanghyuk Jeong">
<meta itemprop="url" content="/">
<div class="footer__author-links">
<div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="이메일 보내기">
      <a class="button button--circle mail-button" itemprop="email" href="mailto:shjeong920522@gmail.com" target="_blank">
        <i class="fas fa-envelope"></i>
      </a>
</li></ul>
</div>
</div>
    </div>
<div class="site-info mt-2">
      <div>© Hyuk's devlog 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> &amp; <a title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div>
</div>
    </div>
<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal">
<script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">검색</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text">
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        취소</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div>
</div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

